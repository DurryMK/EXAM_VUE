{"remainingRequest":"D:\\durry\\HBx\\HBworkplace\\EXAM_VUE\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\durry\\HBx\\HBworkplace\\EXAM_VUE\\src\\components\\Core.vue?vue&type=script&lang=js&","dependencies":[{"path":"D:\\durry\\HBx\\HBworkplace\\EXAM_VUE\\src\\components\\Core.vue","mtime":1606406276709},{"path":"D:\\durry\\HBx\\HBworkplace\\EXAM_VUE\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1606012761609},{"path":"D:\\durry\\HBx\\HBworkplace\\EXAM_VUE\\node_modules\\thread-loader\\dist\\cjs.js","mtime":1606012757189},{"path":"D:\\durry\\HBx\\HBworkplace\\EXAM_VUE\\node_modules\\babel-loader\\lib\\index.js","mtime":1606012784177},{"path":"D:\\durry\\HBx\\HBworkplace\\EXAM_VUE\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1606012761609},{"path":"D:\\durry\\HBx\\HBworkplace\\EXAM_VUE\\node_modules\\vue-loader\\lib\\index.js","mtime":1606012779294}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nfunction formatTimeText(totalTime) {\n\tvar h = Math.floor(totalTime / 60 / 60)\n\tvar m = Math.floor((totalTime - (h * 60 * 60)) / 60)\n\tvar s = (totalTime - (h * 60 * 60) - (m * 60))\n\tif (h < 10) {\n\t\th = \"0\" + h\n\t}\n\tif (m < 10) {\n\t\tm = \"0\" + m\n\t}\n\tif (s < 10) {\n\t\ts = \"0\" + s\n\t}\n\treturn h + \"小时 \" + m + \"分 \" + s + \"秒\"\n}\nexport default {\n\tname: 'Core',\n\tprops: {},\n\tcreated() {\n\n\t},\n\tmounted() {\n\t\tthis.$axios.defaults.withCredentials = true\n\t\tif (this.isCopy) {\n\t\t\t//开启禁止复制\n\t\t\tthis.$nextTick(() => {\n\t\t\t\t// 禁用右键\n\t\t\t\tdocument.oncontextmenu = new Function(\"event.returnValue=false\");\n\t\t\t\t// 禁用选择\n\t\t\t\tdocument.onselectstart = new Function(\"event.returnValue=false\");\n\t\t\t});\n\t\t}\n\t\tif (this.isLeave) {\n\t\t\t//开启页面切换监听\n\t\t\twindow.addEventListener(\"focus\", this.enter);\n\t\t\twindow.addEventListener(\"blur\", this.leave);\n\t\t}\n\t},\n\tdata() {\n\t\treturn {\n\t\t\tpaperId: \"123\", //本张试卷的编号\n\t\t\texamineeId: \"123\", //本场考生的用户id\n\t\t\trunningId: this.getUUID(), //本场考试的唯一标识\n\n\t\t\tisLimit: false, //是否开启考试限时功能\n\t\t\tisCopy: false, //是否开启禁止复制功能\n\t\t\tisPaste: false, //是否开启禁止粘贴功能\n\t\t\tisLeave: true, //是否开启监听切换页面功能\n\t\t\tisCamera: true, //是否开启智能视频监考\n\t\t\tisBegin: false, //是否开始考试\n\t\t\ttotalTime: 120, //考试总时长\n\t\t\ttotalTimeText: '考试尚未开始',\n\n\t\t\tactiveIndex: '0', //顶部激活的菜单\n\t\t\tleaveNum: 3, //允许离开考试界面的次数\n\t\t\tleaveTime: 0, //已经离开考试界面的次数\n\n\t\t\tdetectionTime: 120, //图像采集的持续时间\n\n\t\t\ttimeId: \"\", //计时器id\n\n\t\t\tplayer: null, //视频显示对象\n\t\t}\n\t},\n\tmethods: {\n\t\ttopa(event) {\n\t\t\tconsole.log(event)\n\t\t},\n\t\tenter() {\n\t\t\tconsole.log(\"进入页面\")\n\t\t},\n\t\tleave() {\n\t\t\tif (this.isBegin) {\n\t\t\t\tthis.leaveTime++\n\t\t\t}\n\t\t},\n\t\thandleSelect() {\n\n\t\t},\n\t\tbegin() { //开始考试计时\n\t\t\tif (!this.isBegin) {\n\t\t\t\tif (this.isCamera) {\n\t\t\t\t\tthis.vedioHandle_1() //开启视频监考流程\n\t\t\t\t}\n\t\t\t\tthis.isBegin = true\n\t\t\t\tthis.timeId = setInterval(this.timer_, 1000)\n\t\t\t}\n\t\t},\n\t\tvedioHandle_1() { //视频监考流程处理\n\t\t\t//1.提示开始人脸图像收集\n\t\t\tthis.$confirm('本场考试已开启视频监考,即将开始收集考生人脸图像信息, 是否继续?', '提示', {\n\t\t\t\tconfirmButtonText: '确定',\n\t\t\t\tcancelButtonText: '取消',\n\t\t\t\ttype: 'info',\n\t\t\t\tcenter: true\n\t\t\t}).then(v => {\n\t\t\t\tthis.vedioHandle_2()\n\t\t\t}).catch(() => {\n\t\t\t\tthis.$message({\n\t\t\t\t\ttype: 'error',\n\t\t\t\t\tmessage: '图像采集失败,请刷新页面重试'\n\t\t\t\t});\n\t\t\t});\n\t\t},\n\t\tvedioHandle_2() { //开始人脸图像收集\n\t\t\tthis.$message({\n\t\t\t\ttype: 'success',\n\t\t\t\tmessage: '请保持面部正对摄像头,图像采集将在1分钟内完成',\n\t\t\t\tduration: 6000,\n\t\t\t\ticonClass: 'el-icon-camera-solid'\n\t\t\t});\n\t\t\t//2.打开摄像头\n\t\t\tthis.cameraOpenHandle()\n\t\t\t//3.两分钟内不停截取图像 直到检测到人脸并记录\n\t\t\t//坑：vue中必须使用_this指向this才能实现延迟调用函数的效果\n\t\t\tlet _this = this\n\t\t\tsetTimeout(function() {\n\t\t\t\t_this.faceDetection()\n\t\t\t}, 3000)\n\t\t\t//4.开始计时 两分钟内持续检测\n\t\t\tthis.timeId = setInterval(this.timer__, 1000)\n\t\t},\n\t\tfaceDetection() { //图像采集检测\n\t\t\t//截取一张图像传到服务端检测\n\t\t\tlet imgStr = this.getImage()\n\t\t\timgStr = imgStr.replace(\"data:image/png;base64,\", \"\")\n\t\t\tthis.$axios({\n\t\t\t\turl: this.baseUrl + \"/faceDetectionOp\",\n\t\t\t\tmethod: \"POST\",\n\t\t\t\tparams: {\n\t\t\t\t\timgStr: imgStr,\n\t\t\t\t\tpaperId: this.paperId,\n\t\t\t\t\texamineeId: this.examineeId,\n\t\t\t\t\trunningId: this.runningId,\n\t\t\t\t}\n\t\t\t}).then(res => {\n\t\t\t\tif (res.data.E_BACKSTATUS == '0') {\n\t\t\t\t\tthis.$message({\n\t\t\t\t\t\ttype: 'success',\n\t\t\t\t\t\tmessage: '图像采集已完成,请开始作答',\n\t\t\t\t\t\tduration: 1000,\n\t\t\t\t\t});\n\t\t\t\t\t//停止采集图像倒计时\n\t\t\t\t\tclearInterval(this.timeId)\n\t\t\t\t\t//开启视频监考\n\t\t\t\t\tthis.vedioHandle_3()\n\t\t\t\t} else {\n\t\t\t\t\tthis.$message({\n\t\t\t\t\t\ttype: 'success',\n\t\t\t\t\t\tmessage: '请保持面部正对摄像头,图像采集将在2分钟内完成',\n\t\t\t\t\t\tduration: 2000,\n\t\t\t\t\t\ticonClass: 'el-icon-camera-solid'\n\t\t\t\t\t});\n\t\t\t\t\tthis.$message({\n\t\t\t\t\t\ttype: 'error',\n\t\t\t\t\t\tmessage: res.data.E_BACKINFO,\n\t\t\t\t\t\tduration: 1000,\n\t\t\t\t\t});\n\t\t\t\t\t// 检测失败重新检测\n\t\t\t\t\tif (this.detectionTime > 0) {\n\t\t\t\t\t\t//防止页面闪烁过快 3000调一次接口\n\t\t\t\t\t\tlet _this = this\n\t\t\t\t\t\tsetTimeout(function() {\n\t\t\t\t\t\t\t_this.faceDetection()\n\t\t\t\t\t\t}, 3000)\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})\n\t\t},\n\t\tvedioHandle_3() { //持续的视频监考\n\t\t\tif (this.totalTime == 0) {\n\t\t\t\treturn\n\t\t\t}\n\t\t\t//截取一张图像传到服务端\n\t\t\tlet imgStr = this.getImage()\n\t\t\timgStr = imgStr.replace(\"data:image/png;base64,\", \"\")\n\t\t\tthis.$axios({\n\t\t\t\turl: this.baseUrl + \"/faceCompareOp\",\n\t\t\t\tmethod: \"POST\",\n\t\t\t\tparams: {\n\t\t\t\t\timgStr: imgStr,\n\t\t\t\t\tpaperId: this.paperId,\n\t\t\t\t\texamineeId: this.examineeId,\n\t\t\t\t\trunningId: this.runningId,\n\t\t\t\t}\n\t\t\t}).then(res => {\n\t\t\t\tif (res.data.E_BACKSTATUS == '0') {\n\t\t\t\t\t// 人脸对比成功 \n\t\t\t\t} else {\n\t\t\t\t\t// 对比失败发出警示\n\t\t\t\t\tthis.$message({\n\t\t\t\t\t\ttype: 'error',\n\t\t\t\t\t\tmessage: '考试过程中,请保持面部在采集框内',\n\t\t\t\t\t\tduration: 1000,\n\t\t\t\t\t\ticonClass: 'el-icon-camera-solid'\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tif (this.totalTime > 0) {\n\t\t\t\t\t//继续下一次检测  生成一个随机检测时间\n\t\t\t\t\tlet nextTime = Math.floor(Math.random() * (12 - 1 + 1) + 1)\n\t\t\t\t\tconsole.log(\"下一次检测在\" + nextTime + \"秒后\")\n\t\t\t\t\tlet _this = this\n\t\t\t\t\tsetTimeout(function() {\n\t\t\t\t\t\t_this.vedioHandle_3()\n\t\t\t\t\t}, nextTime * 1000)\n\t\t\t\t}\n\t\t\t})\n\t\t},\n\t\tcameraOpenHandle() { //开启摄像头\n\t\t\t//固定套路\n\t\t\tif (navigator.mediaDevices === undefined) {\n\t\t\t\tnavigator.mediaDevices = {};\n\t\t\t}\n\t\t\tif (navigator.mediaDevices.getUserMedia === undefined) {\n\t\t\t\tnavigator.mediaDevices.getUserMedia = function(constraints) {\n\t\t\t\t\tvar getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;\n\t\t\t\t\tif (!getUserMedia) {\n\t\t\t\t\t\treturn Promise.reject(new Error('getUserMedia is not implemented in this browser'))\n\t\t\t\t\t\tconsole.log(\"浏览器不支持\")\n\t\t\t\t\t}\n\t\t\t\t\treturn new Promise(function(resolve, reject) {\n\t\t\t\t\t\tgetUserMedia.call(navigator, constraints, resolve, reject);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t\tconst constraints = {\n\t\t\t\tvideo: true,\n\t\t\t\taudio: false\n\t\t\t};\n\t\t\tlet videoPlaying = false;\n\t\t\tlet v = document.getElementById('player');\n\t\t\tlet promise = navigator.mediaDevices.getUserMedia(constraints);\n\t\t\tpromise.then(stream => {\n\t\t\t\tif (\"srcObject\" in v) {\n\t\t\t\t\tv.srcObject = stream;\n\t\t\t\t} else {\n\t\t\t\t\tv.src = window.URL.createObjectURL(stream);\n\t\t\t\t}\n\t\t\t\tv.onloadedmetadata = function(e) {\n\t\t\t\t\tv.play();\n\t\t\t\t\tvideoPlaying = true;\n\t\t\t\t};\n\t\t\t}).catch(err => {\n\t\t\t\tconsole.error(err.name + \": \" + err.message);\n\t\t\t})\n\t\t\tthis.player = v\n\t\t},\n\t\tgetImage() { //截取视频框的信息\n\t\t\tlet canvas = document.getElementById(\"canvas\")\n\t\t\tcanvas.getContext('2d').drawImage(this.player, 0, 0, 100, 100)\n\t\t\t// 获取图片base64链接\n\t\t\tvar image = canvas.toDataURL('image/png')\n\t\t\treturn image\n\t\t},\n\t\tstopCa() { //停止摄像\n\t\t\tthis.player.srcObject.getTracks()[0].stop()\n\t\t},\n\t\ttimer_() { //本场考试的计时\n\t\t\tthis.totalTime--\n\t\t\tthis.totalTimeText = formatTimeText(this.totalTime)\n\t\t\tif (this.totalTime == 0) {\n\t\t\t\tthis.isBegin = false\n\t\t\t\tthis.totalTimeText = \"考试已结束\"\n\t\t\t\tthis.stopCa() //关闭摄像头\n\t\t\t\tclearInterval(this.timeId)\n\t\t\t}\n\t\t},\n\t\ttimer__() { //图像采集的计时\n\t\t\tthis.detectionTime--\n\t\t\tif (this.detectionTime == 0) {\n\t\t\t\tclearInterval(this.timeId)\n\t\t\t\tthis.$message({\n\t\t\t\t\ttype: 'error',\n\t\t\t\t\tmessage: '图像采集失败,请刷新页面后重试',\n\t\t\t\t\tduration: 3000,\n\t\t\t\t\ticonClass: 'el-icon-camera-solid'\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n}\n",{"version":3,"sources":["Core.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAmEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"Core.vue","sourceRoot":"src/components","sourcesContent":["<template>\r\n\t<el-container>\r\n\t\t<el-header>\r\n\t\t\t<el-backtop @click.prevent.self=\"topa\" :bottom=\"100\" :visibility-height=1 disabled>\r\n\t\t\t\t<i class=\"el-icon-view\"></i>\r\n\t\t\t</el-backtop>\r\n\t\t\t<el-menu :default-active=\"activeIndex\" class=\"el-menu-demo\" mode=\"horizontal\" @select=\"handleSelect\">\r\n\t\t\t\t<el-menu-item index=\"1\"><i class=\"el-icon-switch-button\"></i>结束考试</el-menu-item>\r\n\t\t\t\t<el-menu-item index=\"2\"><i class=\"el-icon-info\"></i>本场考试须知</el-menu-item>\r\n\t\t\t</el-menu>\r\n\t\t</el-header>\r\n\t\t<el-main>\r\n\t\t\t<el-col :span=\"4\">\r\n\t\t\t\t<!-- 监考区域开考状态 -->\r\n\t\t\t\t<el-card style=\"height: 650px;\">\r\n\t\t\t\t\t<!-- 计时栏 -->\r\n\t\t\t\t\t<el-col :span=\"24\">\r\n\t\t\t\t\t\t<el-tag style=\"width: 100%;background-color: white;\"><i class=\"el-icon-time\"></i>&nbsp;&nbsp;{{totalTimeText}}</span></el-tag>\r\n\t\t\t\t\t</el-col>\r\n\t\t\t\t\t<!-- 智能监考提示语 -->\r\n\t\t\t\t\t<el-col :span=\"24\">\r\n\t\t\t\t\t\t<el-tag type=\"success\" style=\"width: 100%;\"><i class=\"el-icon-view\"></i>&nbsp;&nbsp;智能监考已开启<br />\r\n\t\t\t\t\t\t</el-tag>\r\n\t\t\t\t\t</el-col>\r\n\t\t\t\t\t<!-- 页面监听 -->\r\n\t\t\t\t\t<el-col :span=\"24\" v-show=\"leaveTime!=0\">\r\n\t\t\t\t\t\t<el-tag type=\"warning\" style=\"width: 100%;\"><span><i class=\"el-icon-camera-solid\"></i>&nbsp;&nbsp;你已经离开页面{{leaveTime}}次</span>\r\n\t\t\t\t\t\t</el-tag>\r\n\t\t\t\t\t</el-col>\r\n\t\t\t\t\t<!-- 视频监考区 -->\r\n\t\t\t\t\t<el-col :span=\"24\" style=\"border-radius: 30px\">\r\n\t\t\t\t\t\t<video id=\"player\" style=\"width: 100px;height: 100px;\"></video>\r\n\t\t\t\t\t\t<canvas id=\"canvas\" style=\"display:none;\"></canvas>\r\n\t\t\t\t\t\t<el-button @click=\"stopCa()\">停止</el-button>\r\n\t\t\t\t\t</el-col>\r\n\t\t\t\t</el-card>\r\n\t\t\t</el-col>\r\n\t\t\t<el-col :span=\"19\" :offset=\"1\">\r\n\t\t\t\t<!-- 考试信息确认 -->\r\n\t\t\t\t<el-card v-show=\"!isBegin\" shadow=\"always\" style=\"height: 650px;\">\r\n\t\t\t\t\t<div @click.stop>\r\n\t\t\t\t\t\t<el-button @click=\"begin\">确认开始考试</el-button>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</el-card>\r\n\t\t\t\t<!-- 考试内容 -->\r\n\t\t\t\t<el-card v-show=\"isBegin\" shadow=\"always\" style=\"height: 650px;\">\r\n\t\t\t\t\t<span>请你仔细看：小草在努力生长，花儿在尽情绽放，蝶儿翩翩起舞，飞鸟空中翱翔，校园里学生们认真读书学习，社会中人们勤奋工作、生活……这是我们祖国的美丽画卷，万物的努力都是为祖国赢得更美好的明天！因为，我们都相信，祖国的未来不是梦！\r\n\r\n\t\t\t\t\t\t我们期待着，环保意识注入每个人的心中，环保行动投入整个社会，这是人们现在的梦想，这也会是祖国不久后的现实。“水是生命的源泉”，水滋养了一代又一代人民，净化、荡涤着人们的心灵。为了中国梦，请从现在开始珍惜每一滴水，让每一滴水都滋润中国人的心田！\r\n\r\n\t\t\t\t\t\t在草木茂盛，鸟语花香的季节里，漫步在优美的环境中，总是会令人心旷神怡，那就不要让垃圾污染了美丽的景色。看到垃圾，俯身轻轻拾起，正确地放入分类垃圾桶中。顿时，你会感到心情舒畅，所有人都在向你点头微笑。有了垃圾，不乱丢；看到垃圾，主动拾。那我们的社会将会多么美丽，祖国将会多么整洁，让全世界都仰慕这优美的文化古国——中国！\r\n\r\n\t\t\t\t\t\t我们期待着，这个社会有更多的和谐与无私，这是人们现在的梦想，这也将会是祖国不久后的现实。现在的社会很可作文https://wWw.ZuoWenwang.Net/怕，黑心商人们为了谋取个人的利益，将有毒有害的物质添加进入商品中，如今，就连食物也成了人们心中的危险品。自私吞噬了一些人的美好心灵，请大家敞开心扉，扪心自问，到底该如何来面对这个社会，那答案一定会是：真诚无私。只要抛弃了心中的自私贪婪，让无私，纯真，快乐永驻心中，不再想获得那一丝利益，不再去碰触那一点私心，真诚无私的面对这个世界。那么，快乐将重回人们的脸上，放心将重驻人们的心中，祖国也将更加和谐繁荣！请为了中国梦，真诚无私一次吧！\r\n\r\n\t\t\t\t\t\t我们青少年，也将会是祖国的未来。俗话说：“少年富则国富，少年强则国强。”青少年是国家与民族的希望，只有现在我们努力读书，勤奋刻苦，长大后才能够装点祖国，回报社会。现在，我们是祖国的花朵；将来，我们就是祖国的栋梁，同学们，有了我们的努力，祖国定会大放光彩。请为了中国梦，奋力拼搏，实现人生的价值，释放生命的光辉，因为，我们就是祖国的未来。\r\n\r\n\t\t\t\t\t\t祖国的未来不是梦，我们认真的过每一分钟，祖国的未来不是梦，我们的心跟着希望在动，跟着希望在动……\r\n\r\n\t\t\t\t\t\t哦，沸腾吧，中国梦！</span>\r\n\t\t\t\t</el-card>\r\n\t\t\t</el-col>\r\n\t\t</el-main>\r\n\t</el-container>\r\n\r\n</template>\r\n\r\n<script>\r\n\tfunction formatTimeText(totalTime) {\r\n\t\tvar h = Math.floor(totalTime / 60 / 60)\r\n\t\tvar m = Math.floor((totalTime - (h * 60 * 60)) / 60)\r\n\t\tvar s = (totalTime - (h * 60 * 60) - (m * 60))\r\n\t\tif (h < 10) {\r\n\t\t\th = \"0\" + h\r\n\t\t}\r\n\t\tif (m < 10) {\r\n\t\t\tm = \"0\" + m\r\n\t\t}\r\n\t\tif (s < 10) {\r\n\t\t\ts = \"0\" + s\r\n\t\t}\r\n\t\treturn h + \"小时 \" + m + \"分 \" + s + \"秒\"\r\n\t}\r\n\texport default {\r\n\t\tname: 'Core',\r\n\t\tprops: {},\r\n\t\tcreated() {\r\n\r\n\t\t},\r\n\t\tmounted() {\r\n\t\t\tthis.$axios.defaults.withCredentials = true\r\n\t\t\tif (this.isCopy) {\r\n\t\t\t\t//开启禁止复制\r\n\t\t\t\tthis.$nextTick(() => {\r\n\t\t\t\t\t// 禁用右键\r\n\t\t\t\t\tdocument.oncontextmenu = new Function(\"event.returnValue=false\");\r\n\t\t\t\t\t// 禁用选择\r\n\t\t\t\t\tdocument.onselectstart = new Function(\"event.returnValue=false\");\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\tif (this.isLeave) {\r\n\t\t\t\t//开启页面切换监听\r\n\t\t\t\twindow.addEventListener(\"focus\", this.enter);\r\n\t\t\t\twindow.addEventListener(\"blur\", this.leave);\r\n\t\t\t}\r\n\t\t},\r\n\t\tdata() {\r\n\t\t\treturn {\r\n\t\t\t\tpaperId: \"123\", //本张试卷的编号\r\n\t\t\t\texamineeId: \"123\", //本场考生的用户id\r\n\t\t\t\trunningId: this.getUUID(), //本场考试的唯一标识\r\n\r\n\t\t\t\tisLimit: false, //是否开启考试限时功能\r\n\t\t\t\tisCopy: false, //是否开启禁止复制功能\r\n\t\t\t\tisPaste: false, //是否开启禁止粘贴功能\r\n\t\t\t\tisLeave: true, //是否开启监听切换页面功能\r\n\t\t\t\tisCamera: true, //是否开启智能视频监考\r\n\t\t\t\tisBegin: false, //是否开始考试\r\n\t\t\t\ttotalTime: 120, //考试总时长\r\n\t\t\t\ttotalTimeText: '考试尚未开始',\r\n\r\n\t\t\t\tactiveIndex: '0', //顶部激活的菜单\r\n\t\t\t\tleaveNum: 3, //允许离开考试界面的次数\r\n\t\t\t\tleaveTime: 0, //已经离开考试界面的次数\r\n\r\n\t\t\t\tdetectionTime: 120, //图像采集的持续时间\r\n\r\n\t\t\t\ttimeId: \"\", //计时器id\r\n\r\n\t\t\t\tplayer: null, //视频显示对象\r\n\t\t\t}\r\n\t\t},\r\n\t\tmethods: {\r\n\t\t\ttopa(event) {\r\n\t\t\t\tconsole.log(event)\r\n\t\t\t},\r\n\t\t\tenter() {\r\n\t\t\t\tconsole.log(\"进入页面\")\r\n\t\t\t},\r\n\t\t\tleave() {\r\n\t\t\t\tif (this.isBegin) {\r\n\t\t\t\t\tthis.leaveTime++\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\thandleSelect() {\r\n\r\n\t\t\t},\r\n\t\t\tbegin() { //开始考试计时\r\n\t\t\t\tif (!this.isBegin) {\r\n\t\t\t\t\tif (this.isCamera) {\r\n\t\t\t\t\t\tthis.vedioHandle_1() //开启视频监考流程\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis.isBegin = true\r\n\t\t\t\t\tthis.timeId = setInterval(this.timer_, 1000)\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tvedioHandle_1() { //视频监考流程处理\r\n\t\t\t\t//1.提示开始人脸图像收集\r\n\t\t\t\tthis.$confirm('本场考试已开启视频监考,即将开始收集考生人脸图像信息, 是否继续?', '提示', {\r\n\t\t\t\t\tconfirmButtonText: '确定',\r\n\t\t\t\t\tcancelButtonText: '取消',\r\n\t\t\t\t\ttype: 'info',\r\n\t\t\t\t\tcenter: true\r\n\t\t\t\t}).then(v => {\r\n\t\t\t\t\tthis.vedioHandle_2()\r\n\t\t\t\t}).catch(() => {\r\n\t\t\t\t\tthis.$message({\r\n\t\t\t\t\t\ttype: 'error',\r\n\t\t\t\t\t\tmessage: '图像采集失败,请刷新页面重试'\r\n\t\t\t\t\t});\r\n\t\t\t\t});\r\n\t\t\t},\r\n\t\t\tvedioHandle_2() { //开始人脸图像收集\r\n\t\t\t\tthis.$message({\r\n\t\t\t\t\ttype: 'success',\r\n\t\t\t\t\tmessage: '请保持面部正对摄像头,图像采集将在1分钟内完成',\r\n\t\t\t\t\tduration: 6000,\r\n\t\t\t\t\ticonClass: 'el-icon-camera-solid'\r\n\t\t\t\t});\r\n\t\t\t\t//2.打开摄像头\r\n\t\t\t\tthis.cameraOpenHandle()\r\n\t\t\t\t//3.两分钟内不停截取图像 直到检测到人脸并记录\r\n\t\t\t\t//坑：vue中必须使用_this指向this才能实现延迟调用函数的效果\r\n\t\t\t\tlet _this = this\r\n\t\t\t\tsetTimeout(function() {\r\n\t\t\t\t\t_this.faceDetection()\r\n\t\t\t\t}, 3000)\r\n\t\t\t\t//4.开始计时 两分钟内持续检测\r\n\t\t\t\tthis.timeId = setInterval(this.timer__, 1000)\r\n\t\t\t},\r\n\t\t\tfaceDetection() { //图像采集检测\r\n\t\t\t\t//截取一张图像传到服务端检测\r\n\t\t\t\tlet imgStr = this.getImage()\r\n\t\t\t\timgStr = imgStr.replace(\"data:image/png;base64,\", \"\")\r\n\t\t\t\tthis.$axios({\r\n\t\t\t\t\turl: this.baseUrl + \"/faceDetectionOp\",\r\n\t\t\t\t\tmethod: \"POST\",\r\n\t\t\t\t\tparams: {\r\n\t\t\t\t\t\timgStr: imgStr,\r\n\t\t\t\t\t\tpaperId: this.paperId,\r\n\t\t\t\t\t\texamineeId: this.examineeId,\r\n\t\t\t\t\t\trunningId: this.runningId,\r\n\t\t\t\t\t}\r\n\t\t\t\t}).then(res => {\r\n\t\t\t\t\tif (res.data.E_BACKSTATUS == '0') {\r\n\t\t\t\t\t\tthis.$message({\r\n\t\t\t\t\t\t\ttype: 'success',\r\n\t\t\t\t\t\t\tmessage: '图像采集已完成,请开始作答',\r\n\t\t\t\t\t\t\tduration: 1000,\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\t//停止采集图像倒计时\r\n\t\t\t\t\t\tclearInterval(this.timeId)\r\n\t\t\t\t\t\t//开启视频监考\r\n\t\t\t\t\t\tthis.vedioHandle_3()\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis.$message({\r\n\t\t\t\t\t\t\ttype: 'success',\r\n\t\t\t\t\t\t\tmessage: '请保持面部正对摄像头,图像采集将在2分钟内完成',\r\n\t\t\t\t\t\t\tduration: 2000,\r\n\t\t\t\t\t\t\ticonClass: 'el-icon-camera-solid'\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tthis.$message({\r\n\t\t\t\t\t\t\ttype: 'error',\r\n\t\t\t\t\t\t\tmessage: res.data.E_BACKINFO,\r\n\t\t\t\t\t\t\tduration: 1000,\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\t// 检测失败重新检测\r\n\t\t\t\t\t\tif (this.detectionTime > 0) {\r\n\t\t\t\t\t\t\t//防止页面闪烁过快 3000调一次接口\r\n\t\t\t\t\t\t\tlet _this = this\r\n\t\t\t\t\t\t\tsetTimeout(function() {\r\n\t\t\t\t\t\t\t\t_this.faceDetection()\r\n\t\t\t\t\t\t\t}, 3000)\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t},\r\n\t\t\tvedioHandle_3() { //持续的视频监考\r\n\t\t\t\tif (this.totalTime == 0) {\r\n\t\t\t\t\treturn\r\n\t\t\t\t}\r\n\t\t\t\t//截取一张图像传到服务端\r\n\t\t\t\tlet imgStr = this.getImage()\r\n\t\t\t\timgStr = imgStr.replace(\"data:image/png;base64,\", \"\")\r\n\t\t\t\tthis.$axios({\r\n\t\t\t\t\turl: this.baseUrl + \"/faceCompareOp\",\r\n\t\t\t\t\tmethod: \"POST\",\r\n\t\t\t\t\tparams: {\r\n\t\t\t\t\t\timgStr: imgStr,\r\n\t\t\t\t\t\tpaperId: this.paperId,\r\n\t\t\t\t\t\texamineeId: this.examineeId,\r\n\t\t\t\t\t\trunningId: this.runningId,\r\n\t\t\t\t\t}\r\n\t\t\t\t}).then(res => {\r\n\t\t\t\t\tif (res.data.E_BACKSTATUS == '0') {\r\n\t\t\t\t\t\t// 人脸对比成功 \r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t// 对比失败发出警示\r\n\t\t\t\t\t\tthis.$message({\r\n\t\t\t\t\t\t\ttype: 'error',\r\n\t\t\t\t\t\t\tmessage: '考试过程中,请保持面部在采集框内',\r\n\t\t\t\t\t\t\tduration: 1000,\r\n\t\t\t\t\t\t\ticonClass: 'el-icon-camera-solid'\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (this.totalTime > 0) {\r\n\t\t\t\t\t\t//继续下一次检测  生成一个随机检测时间\r\n\t\t\t\t\t\tlet nextTime = Math.floor(Math.random() * (12 - 1 + 1) + 1)\r\n\t\t\t\t\t\tconsole.log(\"下一次检测在\" + nextTime + \"秒后\")\r\n\t\t\t\t\t\tlet _this = this\r\n\t\t\t\t\t\tsetTimeout(function() {\r\n\t\t\t\t\t\t\t_this.vedioHandle_3()\r\n\t\t\t\t\t\t}, nextTime * 1000)\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t},\r\n\t\t\tcameraOpenHandle() { //开启摄像头\r\n\t\t\t\t//固定套路\r\n\t\t\t\tif (navigator.mediaDevices === undefined) {\r\n\t\t\t\t\tnavigator.mediaDevices = {};\r\n\t\t\t\t}\r\n\t\t\t\tif (navigator.mediaDevices.getUserMedia === undefined) {\r\n\t\t\t\t\tnavigator.mediaDevices.getUserMedia = function(constraints) {\r\n\t\t\t\t\t\tvar getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;\r\n\t\t\t\t\t\tif (!getUserMedia) {\r\n\t\t\t\t\t\t\treturn Promise.reject(new Error('getUserMedia is not implemented in this browser'))\r\n\t\t\t\t\t\t\tconsole.log(\"浏览器不支持\")\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\treturn new Promise(function(resolve, reject) {\r\n\t\t\t\t\t\t\tgetUserMedia.call(navigator, constraints, resolve, reject);\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tconst constraints = {\r\n\t\t\t\t\tvideo: true,\r\n\t\t\t\t\taudio: false\r\n\t\t\t\t};\r\n\t\t\t\tlet videoPlaying = false;\r\n\t\t\t\tlet v = document.getElementById('player');\r\n\t\t\t\tlet promise = navigator.mediaDevices.getUserMedia(constraints);\r\n\t\t\t\tpromise.then(stream => {\r\n\t\t\t\t\tif (\"srcObject\" in v) {\r\n\t\t\t\t\t\tv.srcObject = stream;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tv.src = window.URL.createObjectURL(stream);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tv.onloadedmetadata = function(e) {\r\n\t\t\t\t\t\tv.play();\r\n\t\t\t\t\t\tvideoPlaying = true;\r\n\t\t\t\t\t};\r\n\t\t\t\t}).catch(err => {\r\n\t\t\t\t\tconsole.error(err.name + \": \" + err.message);\r\n\t\t\t\t})\r\n\t\t\t\tthis.player = v\r\n\t\t\t},\r\n\t\t\tgetImage() { //截取视频框的信息\r\n\t\t\t\tlet canvas = document.getElementById(\"canvas\")\r\n\t\t\t\tcanvas.getContext('2d').drawImage(this.player, 0, 0, 100, 100)\r\n\t\t\t\t// 获取图片base64链接\r\n\t\t\t\tvar image = canvas.toDataURL('image/png')\r\n\t\t\t\treturn image\r\n\t\t\t},\r\n\t\t\tstopCa() { //停止摄像\r\n\t\t\t\tthis.player.srcObject.getTracks()[0].stop()\r\n\t\t\t},\r\n\t\t\ttimer_() { //本场考试的计时\r\n\t\t\t\tthis.totalTime--\r\n\t\t\t\tthis.totalTimeText = formatTimeText(this.totalTime)\r\n\t\t\t\tif (this.totalTime == 0) {\r\n\t\t\t\t\tthis.isBegin = false\r\n\t\t\t\t\tthis.totalTimeText = \"考试已结束\"\r\n\t\t\t\t\tthis.stopCa() //关闭摄像头\r\n\t\t\t\t\tclearInterval(this.timeId)\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\ttimer__() { //图像采集的计时\r\n\t\t\t\tthis.detectionTime--\r\n\t\t\t\tif (this.detectionTime == 0) {\r\n\t\t\t\t\tclearInterval(this.timeId)\r\n\t\t\t\t\tthis.$message({\r\n\t\t\t\t\t\ttype: 'error',\r\n\t\t\t\t\t\tmessage: '图像采集失败,请刷新页面后重试',\r\n\t\t\t\t\t\tduration: 3000,\r\n\t\t\t\t\t\ticonClass: 'el-icon-camera-solid'\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n</script>\r\n\r\n<style>\r\n</style>\n"]}]}